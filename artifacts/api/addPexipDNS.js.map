{"version":3,"file":"addPexipDNS.js","sourceRoot":"","sources":["../../api/addPexipDNS.ts"],"names":[],"mappings":"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","sourcesContent":["import * as util from \"util\";\nimport * as fs from \"fs\";\nimport * as Buffer from \"buffer\";\nimport * as child from \"child_process\";\nimport {isNullOrUndefined} from \"util\";\nimport * as lodash from \"lodash\";\nimport * as sleep from \"system-sleep\";\nimport * as newman from \"newman\";\nimport {Request, Response} from \"restify\";\n\nfunction addPexipDNS() {\n\n    const INFRACONIG = require(\"./config/infraconfig.json\");\n\n    let postmanenvjson = null;\n    let terraFormState = null;\n    let arg = null;\n\n    process.argv.forEach(function (args) {\n        if (args.indexOf(\"postmanenvfile\") >= 1) {\n            postmanenvjson = arg.split(\"=\")[1];\n        }\n        if (args.indexOf(\"terraformenvfile\") >= 1) {\n            terraFormState = arg.split(\"=\")[1];\n        }\n    });\n\n    postmanenvjson = util.isNullOrUndefined(postmanenvjson) ? \"pexip-gcp-test.postman_environment.json\" : postmanenvjson;\n    terraFormState = util.isNullOrUndefined(terraFormState) ? \"terraform.tfstate\" : terraFormState;\n\n    let fdPostmanEnvFile = fs.openSync(postmanenvjson, \"r\");\n    let nFileSize = 10 * 1 * 1024 * 1024;\n    let readBuffer = new Buffer.Buffer(nFileSize);\n    let nBytesRead = fs.readSync(fdPostmanEnvFile, readBuffer, 0, nFileSize, 0);\n    let postmanEnv = JSON.parse(readBuffer.toString('utf8', 0, nBytesRead));\n\n    let fdterraformEnvFile = fs.openSync(terraFormState, \"r\");\n    let nterraformFileSize = 10 * 1 * 1024 * 1024;\n    let readterraformBuffer = new Buffer.Buffer(nterraformFileSize);\n    let nterraformBytesRead = fs.readSync(fdterraformEnvFile, readterraformBuffer, 0, nterraformFileSize, 0);\n    let terraformEnv = JSON.parse(readterraformBuffer.toString('utf8', 0, nterraformBytesRead));\n\n    /*\n     has to be passed in using credhub\n     postmanEnv.values.forEach(function (item) {\n         if (item.key == \"entitlement_id\") {\n\n         }\n     });\n     */\n\n    let pexipDomain = terraformEnv.modules[0].outputs[\"pexip_domain\"].value\n    let mgrPubIp = terraformEnv.modules[0].outputs[\"pexip_mgr_pubip\"].value\n    let mgrPrivateIp = terraformEnv.modules[0].outputs[\"pexip_mgr_privateip\"].value\n    let mgrUserName = terraformEnv.modules[0].outputs[\"pexip_mgr_username\"].value\n    let mgrPassword = terraformEnv.modules[0].outputs[\"pexip_mgr_password\"].value\n\n\n    postmanEnv.values.forEach(function (item) {\n        if (item.key == \"pexip_mgr_url\") {\n            item.value = \"https://\" + mgrPrivateIp;\n        }\n        if (item.key == \"pexip_mgr_username\") {\n            item.value = mgrUserName;\n        }\n        if (item.key == \"pexip_mgr_password\") {\n            item.value = mgrPassword;\n        }\n        if (item.key == \"pexip_domain\") {\n            item.value = pexipDomain;\n        }\n\n    });\n\n\n    INFRACONIG.forEach(function (dnsList) {\n        if (!isNullOrUndefined(dnsList.dns_servers)) {\n            console.info(dnsList)\n            var dns_servers =  dnsList.dns_servers\n\n            for (let i = 0; i < dns_servers.length; i++) {\n\n                postmanEnv.values.forEach(function (item) {\n                    if (item.key == \"dns_server_address\") {\n                        item.value = dns_servers[i].ip;\n                    }\n                    if (item.key == \"dns_descripton\") {\n                        item.value = dns_servers[i].description;\n                    }\n\n                });\n\n                fs.writeFileSync(postmanenvjson, JSON.stringify(postmanEnv));\n                sleep(20 * 1000);\n\n                newman.run({\n                    collection: './pexip_dns_server.postman_collection.json',\n                    reporters: ['cli'],\n                    insecure: true,\n                    environment: './pexip-gcp-test.postman_environment.json'\n                }, function (err, summary) {\n                    if (err || summary.error) {\n                        console.error('collection run encountered error')\n                        throw err;\n                    }\n                    console.info('collection run complete! iteration - ' + summary.collection);\n                }).on('request', function (err, summary) {\n                    if (err || summary.error) {\n                        console.info('collection run error! request - ' + summary.error);\n                        throw err;\n                    }\n                    console.info('collection  request - ' + summary);\n                    console.info('collection run complete! request - ' + summary.response.code);\n                    console.info('Add Pexip DNS collection run complete! reponse body ' + summary.response.text());\n\n                }).on('assertion', function (err, summary) {\n                    if (err || summary.error) {\n                        console.info('collection run error! assertion - ' + summary.error.name + \" \" + summary.error.message);\n                        // process.abort()\n                        // throw err\n                        throw new Error(summary.error.name + \" \" + summary.error.message);\n                    }\n                    console.info('collection run complete! assertion - ' + summary.collection);\n                }).on('done', function (err, summary) {\n                    if (err || summary.error) {\n                        console.info('collection run error! done - ' + summary.error);\n                        throw err;\n                    }\n                    console.info('collection run complete! done - ' + summary.collection);\n                });\n\n                sleep(30 * 1000);\n            }\n        }\n    }).catch( error => {\n        console.error(error)\n        process.abort()\n    })\n\n\n}\n\naddPexipDNS();"]}