{"version":3,"file":"addPexipTurnServer.js","sourceRoot":"","sources":["../../api/addPexipTurnServer.ts"],"names":[],"mappings":"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","sourcesContent":["import * as util from \"util\";\nimport * as fs from \"fs\";\nimport * as Buffer from \"buffer\";\nimport * as child from \"child_process\";\nimport {isNullOrUndefined} from \"util\";\nimport * as lodash from \"lodash\";\nimport * as sleep from \"system-sleep\";\nimport * as newman from \"newman\";\nimport {Request, Response} from \"restify\";\n\nfunction addPexipTurnServer() {\n\n    let postmanenvjson = null;\n    let terraFormState = null;\n    let arg = null;\n\n    process.argv.forEach(function (args) {\n        if (args.indexOf(\"postmanenvfile\") >= 1) {\n            postmanenvjson = arg.split(\"=\")[1];\n        }\n        if (args.indexOf(\"terraformenvfile\") >= 1) {\n            terraFormState = arg.split(\"=\")[1];\n        }\n    });\n\n    postmanenvjson = util.isNullOrUndefined(postmanenvjson) ? \"pexip-gcp-test.postman_environment.json\" : postmanenvjson;\n    terraFormState = util.isNullOrUndefined(terraFormState) ? \"terraform.tfstate\" : terraFormState;\n\n    let fdPostmanEnvFile = fs.openSync(postmanenvjson, \"r\");\n    let nFileSize = 10 * 1 * 1024 * 1024;\n    let readBuffer = new Buffer.Buffer(nFileSize);\n    let nBytesRead = fs.readSync(fdPostmanEnvFile, readBuffer, 0, nFileSize, 0);\n    let postmanEnv = JSON.parse(readBuffer.toString('utf8', 0, nBytesRead));\n\n    let fdterraformEnvFile = fs.openSync(terraFormState, \"r\");\n    let nterraformFileSize = 10 * 1 * 1024 * 1024;\n    let readterraformBuffer = new Buffer.Buffer(nterraformFileSize);\n    let nterraformBytesRead = fs.readSync(fdterraformEnvFile, readterraformBuffer, 0, nterraformFileSize, 0);\n    let terraformEnv = JSON.parse(readterraformBuffer.toString('utf8', 0, nterraformBytesRead));\n\n    /*\n     has to be passed in using credhub\n     postmanEnv.values.forEach(function (item) {\n         if (item.key == \"entitlement_id\") {\n\n         }\n     });\n     */\n\n    let pexipDomain = terraformEnv.modules[0].outputs[\"pexip_domain\"].value\n    let mgrPubIp = terraformEnv.modules[0].outputs[\"pexip_mgr_pubip\"].value\n    let mgrPrivateIp = terraformEnv.modules[0].outputs[\"pexip_mgr_privateip\"].value\n    let mgrUserName = terraformEnv.modules[0].outputs[\"pexip_mgr_username\"].value\n    let mgrPassword = terraformEnv.modules[0].outputs[\"pexip_mgr_password\"].value\n\n\n    postmanEnv.values.forEach(function (item) {\n        if (item.key == \"pexip_mgr_url\") {\n            item.value = \"https://\" + mgrPrivateIp;\n        }\n        if (item.key == \"pexip_mgr_username\") {\n            item.value = mgrUserName;\n        }\n        if (item.key == \"pexip_mgr_password\") {\n            item.value = mgrPassword;\n        }\n        if (item.key == \"pexip_domain\") {\n            item.value = pexipDomain;\n        }\n\n    });\n\n\n    fs.writeFileSync(postmanenvjson, JSON.stringify(postmanEnv));\n\n    newman.run({\n        collection: './pexip-turn-server.postman_collection.json',\n        reporters: ['cli'],\n        insecure: true,\n        environment: './pexip-gcp-test.postman_environment.json'\n    }, function (err, summary) {\n        if (err || summary.error) {\n            console.error('collection run encountered error')\n            throw err;\n        }\n        console.info('collection run complete! iteration - ' + summary.collection);\n    }).on('request', function (err, summary) {\n        if (err || summary.error) {\n            console.info('collection run error! request - ' + summary.error);\n            throw err;\n        }\n        console.info('collection run complete! request - ' + summary.response.code);\n        console.info('Adding PEXIP TURN SERVER run complete! reponse body ' + summary.response.text());\n    }).on('assertion', function (err, summary) {\n        if (err || summary.error) {\n            console.info('collection run error! assertion - ' + summary.error.name + \" \" + summary.error.message);\n            throw new Error(summary.error.name + \" \" + summary.error.message);\n        }\n        console.info('collection run complete! assertion - ' + summary.collection);\n    }).on('done', function (err, summary) {\n        if (err || summary.error) {\n            console.info('collection run error! done - ' + summary.error);\n            throw err;\n        }\n        console.info('collection run complete! done - ' + summary.collection);\n    });\n\n\n}\n\naddPexipTurnServer();"]}