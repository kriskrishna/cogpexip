{
	"info": {
		"_postman_id": "f67f4d7d-a7b7-2bfb-11e8-478006b67efc",
		"name": "Pexip-GCP",
		"schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
	},
	"item": [
		{
			"name": "create-default-location",
			"event": [
				{
					"listen": "prerequest",
					"script": {
						"id": "27159417-978d-470b-bf3b-0493be28ae10",
						"type": "text/javascript",
						"exec": [
							"var locationid = Math.floor(Math.random(1000)*100); ",
							"console.log(`locationid=${locationid}`)",
							"var system_location = {",
							"    \"name\": pm.environment.get(\"pexip_location_name\"),",
							"    \"bdpm_pin_checks_enabled\": \"OFF\",",
							"    \"bdpm_scan_quarantine_enabled\": \"OFF\",",
							"    \"description\": \"default system location that will be used for default inventory\",",
							"    \"id\": locationid,",
							"    \"dns_servers\" : [{\"address\" : \"8.8.8.8\"}],",
							"    \"local_mssip_domain\": \"\",",
							"    \"ntp_servers\" : [{\"address\" : \"0.pexip.pool.ntp.org\"}, {\"address\" : \"3.pexip.pool.ntp.org\"}]",
							"};",
							"pm.environment.set(\"pexip_system_location\", locationid);",
							"pm.environment.set(\"system_location\", JSON.stringify(system_location));",
							"",
							""
						]
					}
				}
			],
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{{system_location}}"
				},
				"url": {
					"raw": "{{pexip_mgr_url}}/api/admin/configuration/v1/system_location/",
					"host": [
						"{{pexip_mgr_url}}"
					],
					"path": [
						"api",
						"admin",
						"configuration",
						"v1",
						"system_location",
						""
					]
				}
			},
			"response": []
		},
		{
			"name": "create_conf_node_config",
			"event": [
				{
					"listen": "test",
					"script": {
						"id": "eaa9e62b-bd51-4878-b7d5-1d5ed19f7024",
						"type": "text/javascript",
						"exec": [
							"tests[\"Successful POST request\"] = responseCode.code === 201 || responseCode.code === 202;",
							"",
							"pm.environment.set(\"pexip_confnode_config\", responseBody);",
							"console.log(`loaded response from request ${responseBody}`);"
						]
					}
				},
				{
					"listen": "prerequest",
					"script": {
						"id": "ce9b5821-3e55-443a-9ce7-f96f41580f92",
						"type": "text/javascript",
						"exec": [
							"console.log(`${pm.globals.get(\"pexip_confnode_name\")}`);",
							"",
							"var systemLocation = \"/api/admin/configuration/v1/system_location/\" + pm.environment.get(\"pexip_system_location\") + \"/\";",
							"var configPayload = {",
							"  \"name\": pm.environment.get(\"pexip_confnode_name\"),",
							"  \"hostname\": pm.environment.get(\"pexip_confnode_hostname\"),",
							"  \"domain\": pm.environment.get(\"pexip_domain\"),",
							"  \"address\": pm.environment.get(\"pexip_confnode_address\"),",
							"  \"netmask\": pm.environment.get(\"pexip_confnode_netmask\"),",
							"  \"gateway\": pm.environment.get(\"pexip_confnode_gateway\"),",
							"  \"password\": pm.environment.get(\"pexip_mgr_password\"),",
							"  \"node_type\": pm.environment.get(\"pexip_node_type\"),",
							"  \"system_location\": systemLocation,",
							"  \"static_nat_address\" : pm.environment.get(\"pexip_confnode_static_nat_address\"),",
							"  \"deployment_type\": \"MANUAL-PROVISION-ONLY\"",
							"};",
							"",
							"console.log(`${JSON.stringify(configPayload)}`);",
							"",
							"postman.setEnvironmentVariable(\"configPayload\", JSON.stringify(configPayload));",
							"",
							"",
							"",
							"",
							""
						]
					}
				}
			],
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{{configPayload}}"
				},
				"url": {
					"raw": "{{pexip_mgr_url}}/api/admin/configuration/v1/worker_vm/",
					"host": [
						"{{pexip_mgr_url}}"
					],
					"path": [
						"api",
						"admin",
						"configuration",
						"v1",
						"worker_vm",
						""
					]
				}
			},
			"response": []
		},
		{
			"name": "upload_conf_node_config",
			"event": [
				{
					"listen": "test",
					"script": {
						"id": "7155268a-e62f-4306-96e0-c43c9e3c8a2e",
						"type": "text/javascript",
						"exec": [
							"tests[\"Successful POST request\"] = responseCode.code === 200;",
							"",
							""
						]
					}
				},
				{
					"listen": "prerequest",
					"script": {
						"id": "c563e396-0807-4b38-b024-df4ebd3f31fc",
						"type": "text/javascript",
						"exec": [
							""
						]
					}
				}
			],
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Content-Type",
						"value": "text/xml"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{{pexip_confnode_config}}\n"
				},
				"url": {
					"raw": "https://{{pexip_confnode_static_nat_address}}:8443/configuration/bootstrap",
					"protocol": "https",
					"host": [
						"{{pexip_confnode_static_nat_address}}"
					],
					"port": "8443",
					"path": [
						"configuration",
						"bootstrap"
					]
				}
			},
			"response": []
		}
	],
	"auth": {
		"type": "basic",
		"basic": [
			{
				"key": "password",
				"value": "{{pexip_mgr_password}}",
				"type": "string"
			},
			{
				"key": "username",
				"value": "{{pexip_mgr_username}}",
				"type": "string"
			}
		]
	},
	"event": [
		{
			"listen": "prerequest",
			"script": {
				"id": "1759e2a3-0c20-4cb3-a781-a3816fe6a38f",
				"type": "text/javascript",
				"exec": [
					""
				]
			}
		},
		{
			"listen": "test",
			"script": {
				"id": "c6975f6c-02fc-4fdf-859c-649359e2049b",
				"type": "text/javascript",
				"exec": [
					""
				]
			}
		}
	]
}